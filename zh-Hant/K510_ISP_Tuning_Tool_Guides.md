![](../zh/images/canaan-cover.png)

**<font face="黑体" size="6" style="float:right">K510 ISP 調諧工具指南</font>**

<font face="黑体"  size=3>文件版本：V1.0.0</font>

<font face="黑体"  size=3>發佈日期：2022-03-31</font>

<div style="page-break-after:always"></div>

<font face="黑体" size=3>**免責聲明**</font>
您購買的產品、服務或特性等應受北京嘉楠捷思資訊技術有限公司（“本公司”，下同）商業合同和條款的約束，本文檔中描述的全部或部分產品、服務或特性可能不在您的購買或使用範圍之內。 除非合同另有約定，本公司不對本文檔的任何陳述、資訊、內容的準確性、可靠性、完整性、行銷型、特定目的性和非侵略性提供任何明示或默示的聲明或保證。 除非另有約定，本文檔僅作為使用指導的參考。
由於產品版本升級或其他原因，本文檔內容將可能在未經任何通知的情況下，不定期進行更新或修改。

**<font face="黑体"  size=3>商標聲明</font>**

“<img src="../zh/images/canaan-logo.png" style="zoom:33%;" />”、“Canaan”圖示、嘉楠和嘉楠其他商標均為北京嘉楠捷思資訊技術有限公司的商標。 本文檔可能提及的其他所有商標或註冊商標，由各自的所有人擁有。

**<font face="黑体"  size=3>版權所有©2022北京嘉楠捷思資訊技術有限公司</font>**
本文檔僅適用K510平台開發設計，非經本公司書面許可，任何單位和個人不得以任何形式對本文檔的部分或全部內容傳播。

**<font face="黑体"  size=3>北京嘉楠捷思資訊技術有限公司</font>**
網址：canaan-creative.com
商務垂詢：salesAI@canaan-creative.com

<div style="page-break-after:always"></div>
# 前言
**<font face="黑体"  size=5>文件目的</font>**
本文檔為ISP Tuning Tool說明文檔。

**<font face="黑体"  size=5>讀者物件</font>**

本檔的主要受眾是有經驗的軟體工程師、圖像演算法工程師、系統設計師和系統集成商，他們希望實現私有應用程式和驅動程式。

**<font face="黑体"  size=5>修訂記錄</font>**
 <font face="宋体"  size=2>修訂記錄累積了每次文檔更新的說明。 最新版本的文件包含以前所有版本的更新內容。 </font>

| 版本號   | 修改者     | 修訂日期 | 修訂說明 |
|  :-----  |-------   |  ------  |  ------  |
| 1.0.0 版 | 系統軟體組 | 2022-03-31 | SDK V1.6發佈 |

<div style="page-break-after:always"></div>
**<font face="黑体"  size=6>目 錄</font>**

[目錄]

<div style="page-break-after:always"></div>

# ISP調優工具框架介紹

本節介紹ISP調優工具和數據流的說明，這些框架和數據流是為上層處理器提供的，用於控制整個ISP圖像優化。

```text
+----------------------------------------------------+
|                                                    |
|                      K510                          |
|                                                    |
|    +-------+        +--------------------------+   |
|    |       |        |                          |   |
|    |  ISP  +------> |   v4l2_drm_isptool.out   |   |
|    |       |        |                          |   |
|    +-------+        +-------------+------------+   |
|                                   |                |
|                                   |                |
|    +-----------------+            |                |
|    |                 |            |                |
|    |   isp-tuningd   | <----------+                |
|    |                 |                             |
|    +^-+--------------+                             |
|     | |                                            |
|     | |                                            |
+----------------------------------------------------+
      | |
      | |
+-------------------------------+
|     | |                       |
|     | |       PC              |
|     | |                       |
|    ++-v------------------+    |
|    |                     |    |
|    |  ISP Tuning Tool    |    |
|    |                     |    |
|    +---------------------+    |
|                               |
+-------------------------------+
```

## 調優工具數據流

通信協議參見客戶端代碼倉庫里的說明文檔，工具包含兩部分，一部分是在PC上運行的用戶端isp-tuningd，程式位於/app/mediactl_lib/isp-tuningd，另一部分是在K510上運行的服務端。 通信預設使用TCP的9982埠。

### 用戶端

ISP Tuning Tool是在PC上運行的應用程式。 除了能設置寄存器外還支持進行AWB校準和CCM校準。

### 服務端

isp-tuningd會從標準輸入接收大小為3133440位元組的yuv圖像（NV12）並廣播給所有客戶端，我們可以使用v4l2_drm_isptool，他會自動啟動isp-tuningd並送入圖像數據，具體用法與v4l2_drm一致。 我們可以用如下命令運行

```shell
cd /app/mediactl_lib
./v4l2_drm_isptool -f video_drm_1080x1920.conf
```

# ISP調優選項

K510 ISP中提供了許多寄存器和表以進行控制和調優。 ISP硬體寄存器的設置對圖像品質非常重要。 目前K510平臺，圖像調優過程只通過TCP Socket實現。

## 調優工具主視窗

本節介紹調優視窗上這些面板的功能。

圖3-1顯示了調優視窗上的整個操作面板

- 面板1是**功能表**，它可以選擇載入配置好的ISP檔或進行校準。
- 面板2是**連接控制面板**，填入開發板的IP位址和埠號（預設9982埠）后點擊綠色的連接按鈕即可連接。
- 面板3是**寄存器面板**，如果你需要設置或讀取的寄存器並不在這裡面則可以使用這個面板進行設置和讀取。
- 面板4是調優**參數選擇面板**，用戶可以根據面板提示文本選擇各種參數或參數位，這些選擇的寄存器將顯示在面板5上。
- 面板5是**調優參數設置面板**，它用於設置或從調優伺服器獲取參數值。
- 面板6是**圖像顯示面板**，他會顯示ISP輸出的圖像，當不需要一直播放時可以點擊中間的暫停按鈕。

![圖3-1 調優工具主視窗](../zh/images/sdk_application/clip_image033.png)

ISP Tuning Tool在連接後**不會**自動獲取所有寄存器值，如果需要獲取所有的寄存器值可以點擊**連接控制面板**右側的讀取按鈕，即可拉取當前的所有寄存器值。

# 標定 & 校準

本節介紹使用ISP調優工具進行標定和校準的說明，包括自動白平衡（AWB）、顏色校正矩陣（CCM）、Gamma和鏡頭陰影（LSC）。

## 空運提單

### 準備工作

1. 標準燈箱，有標準D65光源
2. 標準24色卡，目前僅支援X-RITE色卡
3. 準備標定的相機，能輸出sensor原始圖像或處理后的圖像
4. ISP也僅打開黑電平矯正與去馬賽克演算法模組，CSC等格式轉換模組一定要注意對稱性（矩陣是逆矩陣），另外降噪、銳化等模塊影響不大，不過也盡量關閉，非線性模組與顏色處理模組（GAMMA，寬動態，AWB，CCM，飽和度調整等）必須關閉

### 獲取圖像

1. 相機對準24色卡，確保24色卡撐滿整個畫面，然後抓取圖像，未保證準確可以點擊暫停播放，如下圖所示

    ![圖4-1 拍攝24色卡](../zh/images/sdk_application/clip_image014.jpg)

2. 抓取的圖像注意亮暗適中，太亮太暗都影響標定

### 標定

點擊功能表欄的“Calibration”，選擇“AWB”即可執行標定，程式會自動框選色卡

![圖4-2 自動框選色卡](../zh/images/sdk_application/clip_image016.jpg)

此時按下任意鍵繼續，彈出完成白平衡后的圖像

![圖4-3 完成AWB標定](../zh/images/sdk_application/clip_image018.jpg)

如果沒問題，則繼續按下任意鍵，工具會彈出對話框詢問參數是否合理，是則會將其填入主介面相關寄存器，否則放棄標定結果，如果是則工具會繼續詢問是否寫入設備寄存器。

## 抄送

與AWB標定一致，不再贅述。

## 伽馬

標準的gamma曲線的公式為
$$
Y=aX^b
$$
其中$b$即為Gamma係數，在成像端一般小於1，在顯示端一般大於1。 $a$的值可以根據$b$的值算出來

$$
a=\frac{256}{256^b}
$$
該公式的原理是輸入是256，做完Gamma矯正後仍為256。

Gamma係數b為0.5時，曲線如下圖所示

![](../zh/images/sdk_application/clip_image025.png)

## 斷續器

### 準備工作

- 一張鏡頭拍攝獲得的RAW格式照片

### 原理

因鏡頭的中心與四周通光量不一致，造成圖像亮度不均勻，因此通過曲線擬合生成一個矯正曲面來彌補該問題。

矯正前如下圖所示

![校正前](../zh/images/sdk_application/clip_image029.png)

矯正後如下圖所示

![校正後](../zh/images/sdk_application/clip_image031.png)

**翻譯免責聲明**  
為方便客戶，Canaan 使用 AI 翻譯程式將文字翻譯為多種語言，它可能包含錯誤。 我們不保證提供的譯文的準確性、可靠性或時效性。 對於因依賴已翻譯信息的準確性或可靠性而造成的任何損失或損害，Canaan 概不負責。 如果不同語言翻譯之間存在內容差異，以簡體中文版本為準。

如果您要報告翻譯錯誤或不準確的問題，歡迎通過郵件與我們聯繫。
