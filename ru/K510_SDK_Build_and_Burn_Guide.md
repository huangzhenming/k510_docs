![](../zh/images/canaan-cover.png)

**<font face="黑体" size="6" style="float:right">Руководство по сборке и записи пакета SDK K510</font>**

<font face="黑体"  size=3>Версия документа: V1.0.0</font>

<font face="黑体"  size=3>Опубликовано: 2022-03-07</font>

<div style="page-break-after:always"></div>

<font face="黑体" size=3>**Отказ**</font>
Продукты, услуги или функции, которые вы покупаете, регулируются коммерческими контрактами и условиями Beijing Canaan Jiesi Information Technology Co., Ltd. («Компания», то же самое далее), и все или часть продуктов, услуг или функций, описанных в этом документе, могут не входить в сферу вашей покупки или использования. Если иное не оговорено в договоре, Компания отказывается от всех заявлений или гарантий, явных или подразумеваемых, в отношении точности, надежности, полноты, маркетинга, конкретной цели и ненападения любых заявлений, информации или содержания этого документа. Если не согласовано иное, настоящий документ предоставляется только в качестве руководства для использования.
В связи с обновлением версии продукта или по другим причинам содержимое этого документа может время от времени обновляться или изменяться без какого-либо уведомления.

**<font face="黑体"  size=3>Уведомления о товарных знаках</font>**

""<img src="../zh/images/canaan-logo.png" style="zoom:33%;" />, значок "Canaan", Canaan и другие товарные знаки Canaan и другие товарные знаки Canaan являются товарными знаками Beijing Canaan Jiesi Information Technology Co., Ltd. Все другие товарные знаки или зарегистрированные товарные знаки, которые могут быть упомянуты в этом документе, принадлежат их соответствующим владельцам.

**<font face="黑体"  size=3>Copyright ©2022 Пекин Ханаан Цзеси Информационные технологии Co., Ltd</font>**
Настоящий документ применим только к разработке и проектированию платформы K510, без письменного разрешения компании, ни одно подразделение или частное лицо не может распространять часть или все содержание этого документа в любой форме.

**<font face="黑体"  size=3>Пекин Ханаан Цзеси Информационные Технологии Co., Ltd</font>**
URL: canaan-creative.com
Бизнес-запросы: salesAI@canaan-creative.com

<div style="page-break-after:always"></div>
# предисловие
**<font face="黑体"  size=5>Назначение </font>**документа
Этот документ является сопутствующим документом к пакету SDK K510 и предназначен для того, чтобы помочь инженерам понять компиляцию и запись пакета SDK K510.

**<font face="黑体"  size=5>Объекты чтения</font>**

Основные люди, к которым относится этот документ (это руководство):

- Разработчики программного обеспечения
- Персонал технической поддержки

**<font face="黑体"  size=5>История изменений</font>**
 <font face="宋体"  size=2>Журнал изменений накапливает описание каждого обновления документа. Последняя версия документа содержит обновления для всех предыдущих версий. </font>

| Номер версии   | Изменено     | Дата пересмотра | Примечания к пересмотру |
|  :-----  |-------   |  ------  |  ------  |
| Версия 1.0.0 | Отдел продуктов ИИ | 2022-03-07 |          |
|        |            |            |              |
|        |            |            |              |
|        |            |            |              |
|        |            |            |              |
|        |            |            |              |
|        |            |            |              |
|        |            |            |              |
|        |            |            |              |

<div style="page-break-after:always"></div>
**<font face="黑体"  size=6>Содержание</font>**

[ОГЛАВЛЕНИЯ]

<div style="page-break-after:always"></div>

# 1 Введение

В этом документе описывается содержимое раздела построения среды разработки, например загрузка, компиляция и запись пакета SDK K510.

# 2 k510 sdk

## 2.1 k510 sdk скачать

Адрес проекта k510 SDK: <https://github.com/kendryte/k510_buildroot>

Получите k510 SDK:

```shell
git clone https://github.com/kendryte/k510_buildroot.git
```

## Введение в пакет sdk 2.2 K510

K510 SDK - это встроенная среда разработки Linux, основанная на buildroot в качестве базового фреймворка, основанная на ядре linux K510 (версия linux 4.17.0), u-boot (u-boot версии 2020.01), пакете исходного кода riscv-pk-k510 (BBL), структура каталогов K510 SDK показана на следующем рисунке.

![](../zh/images/sdk_build/image-buildroot.png)

 Файлы K510 SDK описываются следующим образом:

| **файл**        | **Описание содержания**                                                 |
| --------------- | ------------------------------------------------------------ |
| доска           | Папка, которая представляет собой K510 различные конфигурационные файлы и скрипты, такие как конфигурационный файл для генерации образов (genimage-xxx.cfg), buildroot post-image scripts, U-Boot по умолчанию переменные среды и т.д. |
| Config.in       | Он указывает пакет, требующий компиляции buildroot. |
| конфиги         | Папка, где находится файл конфигурации компиляции системной платы по умолчанию. В настоящее время сохраняются файлы конфигурации компиляции по умолчанию для плат K510 CRB-V0.1, K510 CRB-V1.2 и K510 EVB:<br /> -`k510_crb_lp3_v1_2_defconfig`<br />-`k510_crb_lp3_v0_1_defconfig`<br />- `k510_evb_lp3_v1_1_defconfig` |
| внешний.desc   | Файл конфигурации внешнего механизма Buildroot. |
| external.mk     | |
| Makefile        | Основной Makefile k510 SDK. |
| пакет         | Папки, которые в основном являются приложениями K510, Config.in содержимым файла будут определять, какие приложения компилируются в этом каталоге. |
| Патчи         | Папка, где находится файл исправления buildroot, Makefile распакует исходный код, когда файл патча в этом каталоге попадет в соответствующий каталог исходного кода. |
| pkg-скачать    | Папка, которая представляет собой сжатый пакет папки dl. |
| README.md       | Инструкции, связанные с SDK. |
| release_note.md | |
| цепочка инструментов       | , где — цепочка инструментов перекрестной компиляции. |
| дл              | Папка, это пакет dl extract в pkg-download, если есть другие добавленные пакеты, также будет загружен в этот каталог. |

## Версия sdk 2.3 k510

При записи образа, сгенерированного k510 SDK, на плату печатается информация о версии, как показано на следующем рисунке:

```text
#############SDK VERSION############################################
MX2_DEV_0106-02e87077-20220428-153936CST-xxxxx-server
####################################################################
```

После завершения запуска введите в терминал оболочки следующую команду, чтобы просмотреть сведения о версии пакета SDK:

```shell
cat /etc/version/release_version
#############SDK VERSION############################################
MX2_REL_0106-02e87077-20220428-153936CST-xxxx-server
####################################################################
```

**Примечание: Приведенная выше информация может варьироваться в зависимости от версии k510 sdk**.

# 3 Среда компиляции Docker

После загрузки пакета SDK k510 выполните следующую команду в родительском каталоге sdk, чтобы запустить docker:

```shell
sh k510_buildroot/tools/docker/run_k510_docker.sh
```

Последующие операции компиляции выполняются в docker по умолчанию.
Если необходимо настроить локальную среду, обратитесь к разделу[Настройка локальной среды](#env_set)

# 4 Компиляция

## 4.1 Подготовка компиляции

### 4.1.1 Загрузка пакета исходного кода (опционально, может ускорить компиляцию)

Чтобы загрузить пакет исходного кода, выполните следующую команду:

```shell
make dl
```

## 4.2 Компиляция

каталог K510_buildroot/config содержит конфигурационные файлы компиляции для трех плат разработки, а именно`k510_crb_lp3_v0_1_defconfig` , `k510_crb_lp3_v1_2_defconfig`и `k510_evb_lp3_v1_1_defconfig`, этот документ иллюстрируется выбором k510_crb_lp3_v1_2_defconfig в качестве целевого объекта**компиляции**.

В среде k510 docker введите следующую команду, чтобы начать компиляцию:

```shell
make CONF=k510_crb_lp3_v1_2_defconfig
```

![](../zh/images/sdk_build/image-make.png)

Следующее сообщение указывает на успешное завершение компиляции.

![](../zh/images/sdk_build/image-uboot_r.png)

После завершения компиляции создается папка`k510_crb_lp3_v1_2_defconfig`.

![изображение-20220311121912711](../zh/images/sdk_build/image-makeout.png)

Каждый из этих документов описывается следующим образом:

| **файл**    | **Описание содержания**                                                 |
| ----------- | ------------------------------------------------------------ |
| Makefile    | Скомпилируйте изображение для использования Makefile.                                     |
| строить       | Каталог компиляции для всех пакетов исходного кода. Например, ядро linux, u-boot, BBL, busybox и т.д., исходный код будет извлечен в каталог сборки и скомпилирован. |
| хозяин        | Все пути установки пакетов хоста, toolchain также будут скопированы в этот каталог для построения сред кросс-компиляции. |
| Изображения      | Скомпилируйте полученный каталог целевых файлов (см. инструкции ниже для получения дополнительной информации)                     |
| nand_target | Корневой каталог файловой системы Raw (используется для создания образов NandFlash)                  |
| цель      | Корневой файловый каталог необработанной системы (для создания образов eMMC и SD-карт для использования)                 |

каталог K510_crb_lp3_v1_2_defconfig/images представляет собой записанное изображение, в котором описание каждого файла выглядит следующим образом.

| **файл**                   | **Описание содержания**                                                 |
| -------------------------- | ------------------------------------------------------------ |
| бутм-bbl.img              | Образ ядра Linux+bbl (упакованный целевой файл ядра bpl для загрузки uboot bbl) |
| k510.dtb                   | Дерево устройств                                                       |
| sysimage-emmc.img          | Файлы записи emmc: весь пакет был упакован uboot_burn, ядра и bbl              |
| sysImage-sdcard.img        | Файлы записи sdcard: весь пакет был упакован uboot_burn, ядра и bbl            |
| sysImage-nand.img          | Nand burn files: весь пакет был упакован uboot_burn, ядра и bbl              |
| u-boot.bin                 | Двоичный файл uboot                                             |
| U-boot_burn.bin            | uboot записывает файлы                                               |
| uboot-emmc.env             | Переменная среды uboot: используется для запуска emmc                                  |
| uboot-sd.env               | Переменная среды uboot: используется для запуска sdcard                                |
| uboot-nand.env             | Переменная среды uboot: используется для запуска nand                                  |
| vmlinux                    | Файл образа ядра Linux (с отладочной информацией elf)                           |
| рутfs.ext2                | Файл образа rootfs ext2 в формате buildroot                             |
| sysimage-sdcard-debian.img | файлы записи sdcard: образы карт (rootfs в формате debian)                     |

каталог K510_crb_lp3_v1_2_defconfig/build — это исходный код всех скомпилированных объектов, некоторые из которых являются важными документами, описанными ниже.

| **файл**         | **Описание содержания**                  |
| ---------------- | ----------------------------- |
| linux-xxx        | Скомпилированный исходный каталог ядра Linux |
| uboot-xxx        | Скомпилированный исходный каталог Uboot       |
| riscv-hp-k510-xxx| Исходный каталог bbl, в котором компилируется код         |
| ...              |                               |

Примечание: xxx - номер версии. При ссылках на пути kernle, bbl и uboot в последующих разделах xxx представляют номера версий.

**Требуется особое внимание:**При очистке все, что находится под k510_crb_lp3_v1_2_defconfig папкой, будет удалено. Поэтому, если вам нужно изменить код ядра, bbl или uboot, не изменяйте его непосредственно в каталоге сборки, вы можете обратиться к главе 5, чтобы использовать метод override source.

## 4.1 Настройка корневого каталога сборки

Введите команду конфигурации buildroot в среде docker k510:

```shell
make CONF=k510_crb_lp3_v1_2_defconfig menuconfig
```

Результаты выполнения следующие:

![](../zh/images/sdk_build/image-make_men.png)

![](../zh/images/sdk_build/image-make_menu.png)

После завершения настройки, сохранения и выхода из нее также необходимо выполнить следующую команду сохранения конфигурации buildroot:

```shell
make CONF=k510_crb_lp3_v1_2_defconfig savedefconfig
```

Результаты выполнения следующие:

![](../zh/images/sdk_build/image-make_savedef.png)

После завершения вышеуказанной операции пользователь может ввести следующую команду для перекомпиляции:

```shell
make CONF=k510_crb_lp3_v1_2_defconfig
```

## 4.2 Настройка U-Boot

Если вам нужно изменить конфигурацию uboot, вы можете войти в каталог k510_crb_lp3_v1_2_defconfig и ввести следующую команду, чтобы запустить конфигурацию U-Boot:

```shell
make uboot-menuconfig
```

Результаты выполнения следующие:

![](../zh/images/sdk_build/image-uboot_men.png)

![](../zh/images/sdk_build/image-uboot_menu.png)

При выходе из menuuonfig после завершения настройки выберите Сохранить конфигурацию и необходимо выполнить следующую команду сохранения конфигурации:

```shell
make uboot-savedefconfig
```

Результаты выполнения следующие:

![](../zh/images/sdk_build/image-uboot_savedefconfig.png)

Наконец, в каталоге k510_crb_lp3_v1_2_defconfig введите следующую команду, чтобы начать компиляцию:

```shell
make uboot-rebuild
```

Дополнительные сведения см. в описании в следующем разделе.

## 4.3 Компиляция U-Boot

Скомпилированный исходный код U-Boot хранится в каталоге k510_crb_lp3_v1_2_defconfig/build/uboot-xxx, и U-Boot необходимо перекомпилировать, независимо от того, изменяет ли пользователь исходный код U-Boot или перенастраивает uboot.

Войдите в каталог k510_crb_lp3_v1_2_defconfig и введите следующую команду для перекомпиляции U-Boot:

```shell
make uboot-rebuild
```

Результаты выполнения следующие:

![](../zh/images/sdk_build/image-uboot-rebuild.png)

После завершения компиляции в каталоге k510_crb_lp3_v1_2_defconfig/images создается новый файл .bin u-boot.

Если вы хотите повторно создать записанный файл образа с новой u-boot,`k510_crb_lp3_v1_2_defconfig` выполните :в каталоге

```shell
make
```

Результаты выполнения следующие:

![](../zh/images/sdk_build/image-make_u.png)

Когда компиляция будет завершена, вы увидите информацию, сгенерированную следующим файлом изображения.

![](../zh/images/sdk_build/image-uboot_r.png)

## 4.4 Настройка ядра Linux

Если вам нужно изменить конфигурацию ядра, вы можете войти в каталог k510_crb_lp3_v1_2_defconfig и ввести следующую команду, чтобы запустить конфигурацию ядра:

```shell
make linux-menuconfig
```

Результаты выполнения следующие:

![](../zh/images/sdk_build/image-linux_men.png)

![](../zh/images/sdk_build/image-linux_menu.png)

При выходе из menuufig после изменения конфигурации выберите Сохранить конфигурацию и, наконец, выполните следующую команду сохранения конфигурации:

```shell
make linux-savedefconfig
```

Результаты выполнения следующие:

![](../zh/images/sdk_build/image-linux_savedefconfig.png)

Наконец, в каталоге k510_crb_lp3_v1_2_defconfig введите следующую команду, чтобы начать компиляцию:

```shell
make linux-rebuild
```

Дополнительные сведения см. в описании в следующем разделе.

## 4.5 Компиляция ядра Linux

K510_crb_lp3_v1_2_defconfig/build/linux-xxx содержит скомпилированный исходный код Linux, независимо от того, изменяет ли пользователь исходный код Linux или перенастраивает Linux, его необходимо перекомпилировать.

Войдите в каталог k510_crb_lp3_v1_2_defconfig и введите следующую команду для перекомпиляции linux:

```shell
make linux-rebuild
```

Результаты выполнения следующие:

![](../zh/images/sdk_build/image-linux_rebuild.png)

После компиляции в каталоге k510_crb_lp3_v1_2_defconfig/images генерируется новый vmlinux.

Образ ядра Linux должен быть упакован с bbl, после переписывания ядра Linux вам нужно перекомпилировать bbl, чтобы сгенерировать новый образ bbl/kernel для загрузки, поэтому введите следующие две команды.

```shell
make riscv-pk-k510-dirclean
make riscv-pk-k510
```

Результаты выполнения следующие:

![](../zh/images/sdk_build/image-riscv.png)

После завершения компиляции `k510_crb_lp3_v1_2_defconfig/images`в каталоге генерируется новая`bootm-bbl.img`.

Наконец, введите make в каталог k510_crb_lp3_v1_2_defconfig и используйте новый пакет bootm-bbl.img для создания файлов образов emmc и SD-карт.

```shell
make
```

Результаты выполнения следующие:

![](../zh/images/sdk_build/image-make_u.png)

Когда компиляция будет завершена, вы увидите информацию, сгенерированную следующим файлом изображения.

![](../zh/images/sdk_build/image-uboot_r.png)

## 4.6 Компиляция dts

Файл дерева устройств находится в каталоге k510_buildroot/k510_crb_lp3_v1_2_defconfig/build/linux-4.17/arch/riscv/boot/dts/canaan, и когда пользователь только изменяет дерево устройств, можно скомпилировать и декомпилировать только дерево устройств.

Напишите сценарий mkdtb-local.sh, который гласит:

```shell
# !/bin/sh

set -Eeuo pipefail

export BUILDROOT="$(dirname "$(realpath "$0")")"
export VARIANT="${1:-k510_crb_lp3_v1_2}"

if [[ "$VARIANT" = *_defconfig ]]; then
        VARIANT="${VARIANT:0:-10}"
fi

export KERNEL_BUILD_DIR="$BUILDROOT/${VARIANT}_defconfig/build/linux-4.17"
export BINARIES_DIR="$BUILDROOT/${VARIANT}_defconfig/images"
export PATH+=":$BUILDROOT/toolchain/nds64le-linux-glibc-v5d/bin"

riscv64-linux-cpp -nostdinc -I "${KERNEL_BUILD_DIR}/include" -I "${KERNEL_BUILD_DIR}/arch" -undef -x assembler-with-cpp "${KERNEL_BUILD_DIR}/arch/riscv/boot/dts/canaan/${VARIANT}.dts" "${BINARIES_DIR}/${VARIANT}.dts.tmp"

"${KERNEL_BUILD_DIR}/scripts/dtc/dtc" -I dts -o "${BINARIES_DIR}/k510.dtb" "${BINARIES_DIR}/${VARIANT}.dts.tmp"
"${KERNEL_BUILD_DIR}/scripts/dtc/dtc" -I dtb -O dts "${BINARIES_DIR}/k510.dtb" -o "${BINARIES_DIR}/all.dts"

echo "DONE"
echo "${BINARIES_DIR}/k510.dtb"
echo "${BINARIES_DIR}/all.dts"
```

Поместите mkdtb-local.sh в каталог K510_buildroot и выполните следующую команду, чтобы скомпилировать дерево устройств k510_crb_lp3_v1_2_defconfig платы:

```shell
./mkdtb-local.sh k510_crb_lp3_v1_2_defconfig
```

Результаты выполнения следующие:

![](../zh/images/sdk_build/image-mdk_dts.png)

K510.dtb в каталоге k510_crb_lp3_v1_2_defconfig/images — это вновь созданный файл базы данных дерева устройств, а all.dts — это файл дерева декомпилированных устройств.

## 4.7. Компиляция приложения

Пользователи могут обращаться к `package/hello_world` Config.in и makefile для создания собственных приложений, а пользовательские приложения помещаются в каталог k510_buildroot/package.

Процесс компиляции приложения иллюстрируется помещением hello_world проектов в k510_buildroot/пакет в качестве примера.

Измените файлы Config.in в каталоге k510_buildroot в среде размещения.

![](../zh/images/sdk_build/image-vi_config.png)

В Config.in добавьте путь, по которому находится package/hello_world/Config.in, и сохраните его.

![](../zh/images/sdk_build/image-config_list.png)

Введите команду конфигурации buildroot в среде docker k510:

```shell
make CONF=k510_crb_lp3_v1_2_defconfig menuconfig
```

Результаты выполнения следующие:

![](../zh/images/sdk_build/image-build_menu.png)

Откроется страница конфигурации buildroot, выберите параметр Расширенный и, наконец, выберите hello_world, а затем сохраните и выйдите из него.

![](../zh/images/sdk_build/image-extern_option.png)

Введите команду Сохранить конфигурацию в каталоге k510_buildroot.

```shell
make CONF=k510_crb_lp3_v1_2_defconfig savedefconfig
```

Результаты выполнения следующие:

![](../zh/images/sdk_build/image-build_savedef.png)

1) Если компиляция выполняется впервые, то выполните следующие действия:

    В каталоге k510_buildroot введите следующую команду, чтобы скомпилировать всю программу проекта и упаковать hello в файлы образов emmc и SD-карт.

    ```shell
    make CONF=k510_crb_lp3_v1_2_defconfig
    ```

    Результаты выполнения следующие:

    ![](../zh/images/sdk_build/image-build_make_def.png)

    В каталоге k510_buildroot/k510_crb_lp3_v1_2_defconfig/target можно увидеть результирующее приложение hello, которое сообщает, правильно ли скомпилировано приложение.

    ![](../zh/images/sdk_build/image-hello.png)

2) Если он был скомпилирован, просто скомпилируйте приложение и упакуйте его в образ записи, выполните следующие действия:

    Войдите в каталог k510_buildroot/k510_crb_lp3_v1_2_defconfig и введите следующую команду для компиляции приложения hello.

    ```shell
    make hello_world-rebuild
    ```

    Результаты выполнения следующие:

    ![](../zh/images/sdk_build/image-app_build-1.png)

    Перейдите в каталог k510_buildroot/k510_crb_lp3_v1_2_defconfig и введите команду make, чтобы упаковать hello в файлы изображений emmc и SD-карт.

    ```shell
    make
    ```

    Результаты выполнения следующие:

    ![](../zh/images/sdk_build/image-app-build-2.png)

# 5 Разработка с помощью K510 SDK

## 5.1 Исходный код ядра linux/BBL/uboot

Версия uboot, используемая этим SDK, - 2020.01, каталог исправлений uboot - package/patches/uboot, а каталог после исправления - k510_xxx_defconfig/build/uboot-2020.01.

Каталог исправлений ядра, используемый этим sdk, - 4.17, каталог исправлений ядра - package/patches/linux, а исправленный каталог - k510_xxx_defconfig/build/linux-4.17.

BBL этого пакета SDK помещается в качестве целевого пакета в каталог package/riscv-pk-k510/, а источник и номер версии bbl указываются в riscv-pk-k510.mk:

```text
RISCV_PK_K510_VERSION = 1e666d6c5dbab220d2ca57fbd9bec49702599b75
RISCV_PK_K510_SITE = git@github.com:kendryte/k510_BBL.git
RISCV_PK_K510_SITE_METHOD = git
```

## 5.2 Разработка ядра linux/BBL/uboot

Каждое умиротворение, скомпилированное в Buildroot, включая ядро linux/BBL/uboot, реализуется путем загрузки tarball, распаковки, настройки, компиляции, установки и других унифицированных шагов управления пакетами, поэтому, хотя весь исходный код можно увидеть в каталоге k510_buildroot/k510_crb_lp3_v1_2_defconfig/build, информации о контроле версий нет. Даже если код загружен из репозитория git.

Хотя исходный код kernel/BBL/uboot, содержащий данные репозитория git, можно увидеть в каталоге dl/, buildroot кэширует исходный код только в каталоге dl и не рекомендуется разрабатывать непосредственно в этом каталоге.

Для модели разработки buildroot предоставляет способ OVERRIDE_SRCDIR.

Проще говоря, вы можете добавить файл local.mk в каталог k510_crb_lp3_v1_2_defconfig и добавить его:

```text
<pkg1>_OVERRIDE_SRCDIR = /path/to/pkg1/sources
```

- LINUX - это имя пакета ядра
- UBOOT - это ИМЯ ПАКЕТА uboot
- RISCV_PK_K510 — имя пакета bbl

Давайте возьмем ядро Linux в качестве примера, чтобы описать, как его использовать.
Предположим, что я клонировал код ядра в каталоге /data/yourname/workspace/k510_linux_kernel и внес изменения, и хочу скомпилировать под buildroot и протестировать его на плате crb v1.2, вы можете создать local.mk в каталоге k510_crb_lp3_v1_2_defconfig и добавить следующее:

```text
LINUX_OVERRIDE_SRCDIR = /data/yourname/workspace/k510_linux_kernel
```

Выполнение в каталоге k510_crb_lp3_v1_2_defconfig

```shell
make linux-rebuild
```

Вы можете видеть, что ядро было перекомпилировано в каталоге build/linux-custom, используя измененный код в /data/yourname/workspace/k510_linux_kernel.
UBOOT и BBL похожи. Таким образом, можно напрямую модифицировать код ядра и переписать ядро в buildroot, а также инкрементно компилировать образ для тестирования.
Примечание: Исходный код переопределения будет добавлен к суффиксу custom в имени каталога каталога k510_crb_lp3_v1_2_defconfig/build, чтобы различать источник каждого пакета в конфигурации buildroot по умолчанию. Например, в приведенном выше примере ядра Linux компиляция увидит, что код, заданный переопределением, компилируется в каталоге k510_crb_lp3_v1_2_defconfig/build/linux-custom, а не в каталоге k510_crb_lp3_v1_2_defconfig/build/linux-xxx, который мы видели ранее.

Для другого кода в каталоге пакетов или собственных пакетов buildroot таким образом можно разрабатывать под платформой buildroot.

# 6 Запишите изображение

K510 поддерживает режим загрузки sdcard и eMMC, каждый раз, когда компиляция в каталоге k510_buildroot/k510_crb_lp3_v1_2_defconfig/image будет генерировать файлы образов sysimage-sdcard.img и sysimg-emmc.img, два файла могут быть записаны на sdcard и eMMC соответственно.

K510 определяет режим загрузки чипа по состоянию аппаратных контактов boot0 и BOOT1, пожалуйста, обратитесь к разделу инструкций по загрузке платы разработки для конкретных настроек.

| ЗАГРУЗКА1   | ЗАГРУЗКА0   | Режим запуска      |
| ------- | ------- | ------------ |
| 0 (ВКЛ.)   | 0 (ВКЛ.)   | Загрузка с последовательного порта      |
| 0 (ВКЛ.)   | 1 (ВЫКЛ.)  | Загрузка SD-карты      |
| 1 (ВЫКЛ.)  | 0 (ВКЛ.)   | Сапоги NANDFLASH |
| 1 (ВЫКЛ.)  | 1 (ВЫКЛ.)  | Ботинки EMMC      |

![](../zh/images/hw_crb_v1_2/clip_hw_3_9.jpg)

## 6.1 Запишите изображение на SD-карту

### 6.1.1 ubuntu сгорел

Перед вставкой sD-карты в хост введите:

```shell
ls -l /dev/sd*
```

Просмотр текущего запоминающего устройства.

Вставив sD-карту в хост, введите ее еще раз:

```shell
ls -l /dev/sd*
```

Глядя на устройство хранения в это время, новым дополнением является узел устройства SD-карты.

После вставки sD-карты в хост результат выполнения команды ls выглядит следующим образом:

![](../zh/images/sdk_build/image-dev_sd.png)

/dev/sdc — узел устройства SD-карты. **Примечание: Узел устройства SD-карты, сгенерированный в пользовательской среде, может не быть /dev/sdc, и последующие операции должны быть изменены в соответствии с фактическим узлом.**

Введите каталог k510_buildroot/k510_crb_lp3_v1_2_defconfig/image под хостом и введите команду dd для записи sysimage-sdcard.img в SDK:

```shell
sudo dd if=sysimage-sdcard.img of=/dev/sdc bs=1M oflag=sync
```

Результат выполнения под хостом выглядит следующим образом:

![](../zh/images/sdk_build/image-dd.png)

### 6.1.2 Запись под Windows

В Windows SD-карта может быть записана с помощью инструмента «Травление бананов» (адрес загрузки инструмента balena Etcher<https://www.balena.io/etcher/>).

1) Вставьте TF-карту в ПК, затем запустите инструмент ColumnEtcher, нажмите кнопку «Flash from file» интерфейса инструмента, выберите прошивку для записи, как показано на следующем рисунке.

    ![](../zh/images/sdk_build/image-sd_pre0.png)

2) Нажмите кнопку «Выбрать цель» интерфейса инструмента и выберите целевую карту sdcard.

    ![](../zh/images/sdk_build/image-pre1.png)

3) Нажмите кнопку «Flash», чтобы начать мигать, процесс прошивки имеет дисплей индикатора выполнения, flash Finish будет предложен после окончания прошивки.

    | ![](../zh/images/sdk_build/clip_image_p1.jpg) | ![](../zh/images/sdk_build/clip_image_p2.jpg) |
    | --------------------------------------- | --------------------------------------- |
    |                                         |                                         |

4) Когда прошивка будет завершена, вставьте SD-карту в слот платы разработки, выберите BOOT, чтобы начать с SD, и, наконец, плата разработки может быть включена для запуска с SD-карты.

## 6.2 Запишите изображение в emmc

Чтобы записать sysimage-emmc.img на встроенный eMMC, с помощью sdk, в среде ubuntu, sysimage-emmc.img сохраняется в пользовательском разделе sdk, а затем sdk вставляется в плату и включается.

Перед записью образа emmc необходимо размонтировать файловую систему, связанную с emmc, обратитесь к следующим шагам, чтобы размонтировать ее.

```shell
mount | grep emmc
```

Результат выполнения выглядит следующим образом:

![](../zh/images/sdk_build/image-emmc_1.png)

Введите следующую команду для удаления и проверки.

```shell
umount /root/emmc/p2
umount /root/emmc/p3
umount /root/emmc/p4
mount | grep emmc
```

Результат выполнения выглядит следующим образом:

![](../zh/images/sdk_build/image-emmc_2.png)

Наконец, введите путь, по которому находится изображение, введите следующую команду для записи eMMC.

```shell
dd if=sysimage-emmc.img of=/dev/mmcblk0 bs=1M
```

Результат выполнения выглядит следующим образом:

![](../zh/images/sdk_build/image-emmc3.png)

**Примечание: Процесс горения медленный, он занимает около 30 секунд, пожалуйста, будьте терпеливы.**

Когда мигание будет завершено, выберите BOOT to Boot из EMMC и, наконец, включите системную плату для загрузки из EMMC.

# 7 Настраиваемая пользователем среда <a id="env_set">  компиляции</a>

Если вы не используете вышеуказанную среду docker, вы можете настроить свою собственную среду разработки, обратившись к следующей команде ubuntu18.04/20.04, если у вас нет разрешения, пожалуйста, используйте`sudo` его.

```shell
apt-get update
apt-get upgrade
apt-get install libc6-i386 libc6-dev-i386

apt-get install mtools
apt-get install dosfstools
apt-get install python
apt-get install python-pip
python2 -m pip install pycrypto

apt-get install python3.7
apt-get install python3-pip
python3.7 -m pip install --upgrade pip
ln -sf /usr/bin/python3.7 /usr/bin/python3
python3 -m pip install onnx==1.9.0 onnx-simplifier==0.3.6 onnxoptimizer==0.2.6 onnxruntime==1.8.0 -i https://pypi.tuna.tsinghua.edu.cn/simple

#进行下一步，需进入k510_buildroot/nncase目录，将nncase_v1.4.0.tgz解压后进入k510_buildroot/nncase/nncase_v1.4.0目录，输入如下命令安装*.whl
python3 -m pip install x86_64/*.whl
#运行python3 -m pip show nncase，若看到nncase版本信息则表示AI应用程序环境部署成功。
python3 -m pip show nncase

python3 -m pip install xlrd==1.2.0
python3 -m  pip install pystache
dpkg --add-architecture i386
apt update
apt install libncurses5:i386
apt-get install wget
apt-get install cpio
apt-get install unzip
apt-get install rsync
apt-get install bc
apt-get install libssl-dev
pip3 install pycryptodome
```

**Отказ от ответственности за**перевод  
Для удобства клиентов Canaan использует переводчик AI для перевода текста на несколько языков, которые могут содержать ошибки. Мы не гарантируем точность, надежность или своевременность предоставленных переводов. Компания Canaan не несет ответственности за любые убытки или ущерб, вызванные доверием к точности или надежности переведенной информации. При наличии разницы в содержании переводов на разные языки преимущественную силу имеет упрощенная версия на китайском языке.

Если вы хотите сообщить об ошибке или неточности перевода, пожалуйста, не стесняйтесь обращаться к нам по почте.
